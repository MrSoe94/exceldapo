<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baca Data Siswa (Excel Dapodik)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 100%; 
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .upload-section {
            border: 2px dashed #007bff;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f9faff;
            cursor: pointer;
            transition: background 0.3s;
        }
        .upload-section:hover {
            background-color: #e6f0ff;
        }
        input[type="file"] {
            display: none;
        }
        .controls {
            margin-bottom: 20px;
            display: none; 
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            width: 350px; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Tombol Hapus Baru */
        .btn-delete {
            padding: 10px 20px;
            background-color: #dc3545; /* Merah */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-delete:hover {
            background-color: #c82333;
        }
        .btn-delete:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            display: none; 
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap; 
            overflow-x: hidden; 
        }
        /* Styling khusus kolom checkbox */
        th:first-child, td:first-child {
            width: 50px;
            text-align: center;
        }
        th {
            background-color: #0056b3;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 11px;
            cursor: pointer; 
            user-select: none;
        }
        th:hover {
            background-color: #004494;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #e6f0ff;
        }
        .error {
            color: red;
            text-align: center;
            margin-top: 10px;
        }
        .success {
            color: green;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .table-container {
            overflow-x: auto; 
            height: 600px;
        }
        #error-message {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border: 1px solid red;
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÇ Pembaca Data Siswa (Fitur Hapus)</h1>
    
    <div id="error-message">Gagal memuat library Excel. Cek internet Anda.</div>
    
    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <p>Klik di sini untuk memilih file Excel (.xlsx)</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFile(this)">
        <div id="message"></div>
    </div>

    <div class="controls" id="controls">
        <label>Cari Data:</label>
        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Ketik: Nama, Kelas, NISN...">
        
        <!-- Tombol Hapus -->
        <button class="btn-delete" onclick="deleteSelectedRows()">üóëÔ∏è Hapus Terpilih</button>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Variabel untuk tracking sorting
    let lastSortedCol = -1;
    let lastSortDirection = 'asc'; 

    if (typeof XLSX === 'undefined') {
        document.getElementById('error-message').style.display = 'block';
        document.querySelector('.upload-section').style.display = 'none';
    }

    function handleFile(input) {
        const file = input.files[0];
        const messageDiv = document.getElementById('message');
        const table = document.getElementById('dataTable');
        const controls = document.getElementById('controls');
        
        messageDiv.innerHTML = "";
        table.style.display = 'none';
        controls.style.display = 'none';
        document.getElementById('tableHead').innerHTML = "";
        document.getElementById('tableBody').innerHTML = "";

        if (!file) return;

        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                const sheetName = workbook.SheetNames.find(name => name.includes("Daftar Peserta Didik")) || workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (jsonData.length < 5) {
                    throw new Error("File terlalu pendek atau format salah.");
                }

                let mainHeaderIndex = -1;
                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length > 2 && row[0] == "No" && row[1] == "Nama") {
                        mainHeaderIndex = i;
                        break;
                    }
                }

                if (mainHeaderIndex === -1) {
                    throw new Error("Header 'No' dan 'Nama' tidak ditemukan.");
                }

                const topHeaders = jsonData[mainHeaderIndex];
                const bottomHeaders = jsonData[mainHeaderIndex + 1]; 
                let dataRows = jsonData.slice(mainHeaderIndex + 2);

                dataRows = dataRows.filter(row => row.length > 0);

                const mergedHeaders = [];
                for (let i = 0; i < topHeaders.length; i++) {
                    const top = (topHeaders[i] === '*' || topHeaders[i] === undefined) ? '' : topHeaders[i];
                    const bottom = (bottomHeaders[i] === '*' || bottomHeaders[i] === undefined) ? '' : bottomHeaders[i];
                    
                    let finalText = "";
                    if (top && bottom) {
                        finalText = top + " - " + bottom;
                    } else if (bottom) {
                        finalText = bottom;
                    } else if (top) {
                        finalText = top;
                    } else {
                        finalText = "Kolom " + (i+1);
                    }
                    mergedHeaders.push(finalText);
                }

                renderTable(mergedHeaders, dataRows);
                
                messageDiv.className = "success";
                messageDiv.innerText = `Berhasil! Ditemukan ${dataRows.length} data siswa.`;
                table.style.display = 'table';
                controls.style.display = 'flex';

            } catch (error) {
                console.error(error);
                messageDiv.className = "error";
                messageDiv.innerText = error.message || "Gagal membaca file.";
            }
        };

        reader.readAsArrayBuffer(file);
    }

    function renderTable(headers, rows) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = "";
        tbody.innerHTML = "";
        
        const headerRow = document.createElement('tr');

        // 1. Tambah Header "Pilih" di awal
        const thSelect = document.createElement('th');
        thSelect.textContent = "Pilih";
        thSelect.onclick = null; // Kolom ini tidak bisa di-sort
        thSelect.style.cursor = "default";
        thSelect.style.width = "50px";
        headerRow.appendChild(thSelect);

        // 2. Render Header Data
        headers.forEach((headerText, index) => {
            const th = document.createElement('th');
            th.textContent = headerText;
            th.onclick = () => sortTable(index);
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // 3. Render Body
        rows.forEach(row => {
            const tr = document.createElement('tr');

            // Tambah Checkbox di awal setiap baris
            const tdCheck = document.createElement('td');
            tdCheck.style.textAlign = 'center';
            const checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.className = "row-checkbox";
            tdCheck.appendChild(checkbox);
            tr.appendChild(tdCheck);

            // Tambah Data Siswa
            for (let i = 0; i < headers.length; i++) {
                const td = document.createElement('td');
                const cellValue = row[i];
                td.textContent = (cellValue !== undefined && cellValue !== '*') ? cellValue : '-';
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
    }

    // --- FUNGSI HAPUS DATA ---
    function deleteSelectedRows() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
            alert("Tidak ada data yang dipilih.");
            return;
        }

        if (confirm(`Apakah Anda yakin ingin menghapus ${checkboxes.length} data terpilih?`)) {
            const tbody = document.getElementById('tableBody');
            const messageDiv = document.getElementById('message');
            
            // Hapus setiap baris yang checkboxnya tercentang
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                row.remove();
            });

            messageDiv.className = "success";
            messageDiv.innerText = `${checkboxes.length} data berhasil dihapus dari tampilan.`;
        }
    }
    // ------------------------

    function searchTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("dataTable");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
            // Mulai dari 1 karena kolom ke-0 adalah Checkbox
            const tds = tr[i].getElementsByTagName("td");
            let found = false;

            for (let j = 1; j < tds.length; j++) {
                if (tds[j]) {
                    let txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }

            if (found) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }

    function sortTable(n) {
        const table = document.getElementById("dataTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        if (lastSortedCol === n) {
            lastSortDirection = (lastSortDirection === 'asc') ? 'desc' : 'asc';
        } else {
            lastSortedCol = n;
            lastSortDirection = 'asc';
        }

        rows.sort((rowA, rowB) => {
            // +1 karena index 0 adalah kolom checkbox
            let cellA = rowA.getElementsByTagName("td")[n + 1];
            let cellB = rowB.getElementsByTagName("td")[n + 1];
            
            let valA = cellA.textContent.trim();
            let valB = cellB.textContent.trim();

            const hasLetters = /[a-zA-Z]/;

            if (!hasLetters.test(valA) && !hasLetters.test(valB)) {
                let numA = parseFloat(valA.replace(/[^0-9.-]+/g,""));
                let numB = parseFloat(valB.replace(/[^0-9.-]+/g,""));

                if (!isNaN(numA) && !isNaN(numB)) {
                    return lastSortDirection === 'asc' ? numA - numB : numB - numA;
                }
            } 

            valA = valA.toLowerCase();
            valB = valB.toLowerCase();

            if (valA < valB) return lastSortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return lastSortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));

        // Index +1 untuk menyesuaikan dengan header (karena ada kolom checkbox di awal)
        const headers = table.querySelectorAll("th");
        headers.forEach((th, index) => {
            if (index === n + 1) {
                th.textContent = th.textContent.replace(" ‚ñ≤", "").replace(" ‚ñº", "");
                th.textContent += lastSortDirection === 'asc' ? " ‚ñ≤" : " ‚ñº";
            } else {
                th.textContent = th.textContent.replace(" ‚ñ≤", "").replace(" ‚ñº", "");
            }
        });
    }
</script>

</body>
</html>
